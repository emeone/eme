<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>å‡ºç”£æº–å‚™ã‚¬ã‚¤ãƒ‰ Â· å…±æœ‰ä¿å­˜ç‰ˆï¼ˆSupabaseé€£æºï¼‰</title>
  <meta name="theme-color" content="#ff5c8a"/>
  <style>
    :root{ --pink:#ff5c8a; --pink-2:#ff7aa3; --yellow:#ffd54d; --mint:#34c6a1; --ink:#222; --ink-2:#555; --ink-3:#888; --line:#e9e9e9; --pill:#fafafa; --shadow:0 8px 24px rgba(0,0,0,.06); --tap:52px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:'Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--ink);background:#fff}

    /* Header */
    .head{position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid var(--line)}
    .head .wrap{max-width:1200px;margin:0 auto;padding:8px 12px;display:flex;align-items:center;gap:8px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--pink),var(--pink-2))}
    .name{font-family:'Rounded Mplus 1c',sans-serif;font-weight:800}
    .search{flex:1;display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--pill);border:1px solid var(--line);border-radius:999px}
    .search input{flex:1;border:none;background:transparent;outline:none;font-size:16px}
    .actions{display:flex;gap:8px;align-items:center}
    .link{display:inline-flex;align-items:center;gap:6px;min-height:var(--tap);padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#333;text-decoration:none;font-weight:700;font-size:14px}

    .notice{background:linear-gradient(90deg,#fff7f9,#fff);border-bottom:1px solid var(--line)}
    .notice .wrap{max-width:1200px;margin:0 auto;padding:8px 12px;color:#9a3a54;font-size:13px}

    /* Panels/Cards */
    .panel{display:none} .panel[aria-hidden="false"]{display:block}
    .grid{max-width:1200px;margin:0 auto;padding:12px 12px 72px;display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:960px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    .card .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .ttl{font-weight:900;color:#c74363}
    .card .bd{padding:12px}

    /* KPI */
    .kpi{display:flex;align-items:flex-end;gap:10px}
    .big{font-family:'Rounded Mplus 1c',sans-serif;font-weight:800;font-size:40px;color:#c74363}
    .muted{color:var(--ink-3);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{flex:1;min-width:140px;background:var(--pill);border:1px solid var(--line);border-radius:14px;padding:12px;text-align:center}

    /* Lists */
    .tabs{position:sticky;top:54px;background:#fff;z-index:40;display:flex;gap:8px;border-bottom:2px solid var(--line);padding:0 12px;overflow-x:auto}
    .tabs button{appearance:none;background:none;border:none;padding:14px 10px;font-weight:900;color:#444;border-bottom:3px solid transparent;cursor:pointer;flex:0 0 auto}
    .tabs button[aria-selected="true"]{color:#c74363;border-bottom-color:#ff9bbb}
    .tools{display:flex;gap:8px;flex-wrap:wrap;padding:10px 12px}
    .list{padding:0 12px 12px;display:grid;gap:10px}
    .group{border:1px solid var(--line);border-radius:14px;background:#fff}
    .group h3{margin:0;padding:12px 14px;border-bottom:1px dashed var(--line);color:#c74363;font-size:15px}
    .item{display:flex;gap:12px;padding:14px;align-items:flex-start;cursor:pointer;outline:none}
    .item:hover{background:#fff7fb}
    .item input[type="checkbox"]{position:absolute;opacity:0;width:1px;height:1px}
    .check{width:26px;height:26px;border-radius:50%;border:2px solid #ff7aa3;display:grid;place-items:center;color:#fff;flex:0 0 26px}
    .item input[type="checkbox"]:checked + .check{background:var(--mint);border-color:var(--mint)}
    .badge{display:inline-block;padding:3px 8px;background:#ff7aa3;color:#fff;border-radius:999px;font-size:11px;margin-left:6px}
    .meta{font-size:12px;color:#c1c1c1}
    .ops{margin-left:auto;display:flex;gap:8px}
    .iconbtn{appearance:none;background:#fff;border:1px solid var(--line);border-radius:8px;padding:4px 6px;cursor:pointer;color:#c74363}
    .nohit{margin:0 12px 12px;padding:12px 14px;color:#9a3a54;background:#fff7fb;border:1px dashed #ffc7da;border-radius:12px}

    /* Info */
    .info-grid{display:grid;grid-template-columns:1fr;gap:10px;padding:0 12px 12px}
    @media (min-width:960px){.info-grid{grid-template-columns:repeat(3,1fr)}}
    .info-card{border:1px solid var(--line);border-left:4px solid #ffd54d;background:#fffef6;border-radius:14px;padding:14px}

    /* Bottom Tabbar */
    .tabbar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(4,1fr);height:60px;padding-bottom:calc(env(safe-area-inset-bottom));z-index:70}
    .tabbar button{appearance:none;background:none;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;font-weight:800;color:#666}
    .tabbar button[aria-selected="true"]{color:#c74363}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.35);z-index:80;padding:0}
    .sheet{width:100%;max-width:560px;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -6px 24px rgba(0,0,0,.2)}
    .sheet-h{display:flex;justify-content:space-between;align-items:center;padding:14px;background:#fff7fb;color:#c74363;font-weight:900;border-bottom:1px solid var(--line)}
    .sheet-b{padding:14px}
    .sheet-a{display:flex;gap:8px;padding:12px 14px;justify-content:flex-end;border-top:1px solid var(--line)}
    .close-x{appearance:none;background:none;border:none;font-size:22px;line-height:1;cursor:pointer;color:#c74363}
    .field{display:grid;gap:6px;margin-bottom:10px}
    select, input[type="text"], input[type="date"], textarea{padding:10px;border:1px solid var(--line);border-radius:10px;font-size:15px}

    /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰è¦–è¦šãƒ’ãƒ³ãƒˆ */
    body[data-edit="on"] .head{box-shadow:0 0 0 3px rgba(52,198,161,.3) inset}
    body[data-edit="on"] .notice .wrap::after{content:"ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰";margin-left:6px;color:#34c6a1;font-weight:900}
  </style>
</head>
<body>
  <header class="head" role="banner">
    <div class="wrap">
      <div class="brand"><div class="logo" aria-hidden="true"></div><div class="name">å‡ºç”£æº–å‚™ã‚¬ã‚¤ãƒ‰</div></div>
      <div class="search" role="search">
        <span aria-hidden="true">ğŸ”</span>
        <input id="kw" placeholder="ä¾‹ï¼šå…ç«¥æ‰‹å½“ã€ãƒãƒ£ã‚¤ãƒ«ãƒ‰ã‚·ãƒ¼ãƒˆ" aria-label="ã‚µã‚¤ãƒˆå†…æ¤œç´¢ï¼ˆç”³è«‹ãƒ»æº–å‚™ãƒ»æƒ…å ±ï¼‰"/>
      </div>
      <div class="actions">
        <button class="link" id="btnAdd">ï¼‹ è¿½åŠ </button>
        <!-- è¿½åŠ ï¼šç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON/OFF -->
        <button class="link" id="btnEditOn">ğŸ”‘ ç·¨é›†ON</button>
        <button class="link" id="btnEditOff">ğŸš« ç·¨é›†OFF</button>
      </div>
    </div>
  </header>
  <div class="notice"><div class="wrap">ãŠçŸ¥ã‚‰ã›ï¼šæƒ…å ±ã¯2026å¹´2æœˆæ™‚ç‚¹ã®ã‚‚ã®ã§ã™ã€‚æœ€æ–°ã¯å„çª“å£ã§ã”ç¢ºèªãã ã•ã„ã€‚<strong>ã“ã®å…±æœ‰ç‰ˆã¯Supabaseã«ä¿å­˜</strong>ã•ã‚Œã€ç·¨é›†ã«ã¯ç·¨é›†ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚</div></div>

  <!-- Panels -->
  <section id="panel-home" class="panel" aria-hidden="false" aria-label="ãƒ›ãƒ¼ãƒ ">
    <div class="grid">
      <article class="card" aria-labelledby="c-ttl">
        <div class="hd"><div class="ttl" id="c-ttl">äºˆå®šæ—¥ã¾ã§ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</div><button class="link" id="btnDue2">äºˆå®šæ—¥ã‚’å¤‰æ›´</button></div>
        <div class="bd">
          <div class="kpi" aria-live="polite" aria-atomic="true">
            <div class="big" id="daysLeft">--</div>
            <div class="muted" id="dueLabel">å‡ºç”£äºˆå®šæ—¥ã¾ã§</div>
          </div>
          <div class="row">
            <div class="pill"><div class="muted">ç¾åœ¨</div><strong id="currentWeek">--é€±--æ—¥</strong></div>
            <div class="pill"><div class="muted">äºˆå®šæ—¥</div><strong id="dueDate">--/--</strong></div>
          </div>
          <details id="d-growth" open>
            <summary>ğŸ“ˆ ä»Šé€±ã®æˆé•·ï¼ˆã‚µã‚¤ã‚ºãƒ»ä½“é‡ãƒ»é€±æ•°ï¼‰</summary>
            <div class="content">
              <div class="stats">
                <div class="stat"><div class="muted">å¤§ãã•</div><div class="v" id="babySize">--cm</div></div>
                <div class="stat"><div class="muted">ä½“é‡</div><div class="v" id="babyWeight">--g</div></div>
                <div class="stat"><div class="muted">é€±æ•°</div><div class="v" id="wk">--é€±</div></div>
              </div>
            </div>
          </details>
          <details id="d-advice" open>
            <summary>ğŸ’¡ ä»Šé€±ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</summary>
            <div class="content"><ul id="adviceList" style="margin:6px 0 0 1em;padding:0"></ul></div>
          </details>
          <p class="muted" style="margin:8px 0 0">â€» äºˆå®šæ—¥ã®è¨­å®šãƒ»å¤‰æ›´ã¯ã€Œäºˆå®šæ—¥ã‚’å¤‰æ›´ã€ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„ã€‚</p>
        </div>
      </article>

      <article class="card" id="timeline" aria-labelledby="t-ttl">
        <div class="hd"><div class="ttl" id="t-ttl">ã‚„ã‚‹ã“ã¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆå‡ºç”£å‰å¾Œï¼‰</div></div>
        <div class="bd">
          <div id="timelineList" class="timeline" style="display:grid;gap:8px"></div>
          <p class="muted" style="margin-top:6px">â€» äºˆå®šæ—¥ã‚’ã‚‚ã¨ã«å‰å¾Œã®ç›®å®‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚æ–½è¨­ã®æŒ‡ç¤ºãŒã‚ã‚‹å ´åˆã¯ãã¡ã‚‰ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚</p>
        </div>
      </article>
    </div>
  </section>

  <section id="panel-list" class="panel" aria-hidden="true" aria-label="ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ">
    <div class="grid">
      <article class="card" id="checklist" aria-labelledby="l-ttl">
        <div class="hd"><div class="ttl" id="l-ttl">ç”³è«‹ãƒ»æº–å‚™ãƒªã‚¹ãƒˆ</div><div class="muted" id="progress">é€²æ— --%</div></div>
        <div class="bd">
          <div class="tabs" role="tablist" aria-label="ã‚«ãƒ†ã‚´ãƒª">
            <button class="tab" role="tab" data-tab="applications" aria-selected="true" aria-controls="tabContent">ç”³è«‹æ‰‹ç¶šã</button>
            <button class="tab" role="tab" data-tab="preparation" aria-selected="false" aria-controls="tabContent">å‡ºç”£æº–å‚™</button>
            <button class="tab" role="tab" data-tab="hospital" aria-selected="false" aria-controls="tabContent">å…¥é™¢æº–å‚™</button>
          </div>
          <div class="tools">
            <button class="link" id="btnAdd2">ï¼‹ è¿½åŠ </button>
            <button class="link" id="btnResetChecks">ãƒã‚§ãƒƒã‚¯ã®ã¿ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="link" id="btnResetCustom">ã‚«ã‚¹ã‚¿ãƒ é …ç›®ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <div id="tabContent" class="list" role="group" aria-label="ãƒã‚§ãƒƒã‚¯é …ç›®"></div>
        </div>
      </article>
    </div>
  </section>

  <section id="panel-info" class="panel" aria-hidden="true" aria-label="æƒ…å ±">
    <div class="grid">
      <article class="card" aria-labelledby="i-ttl">
        <div class="hd"><div class="ttl" id="i-ttl">æƒ…å ±ãƒ»å•ã„åˆã‚ã›ï¼ˆæœ­å¹Œï¼‰</div></div>
        <div class="bd">
          <div class="info-grid" id="infoGrid">
            <section class="info-card" data-search="æœ­å¹Œå¸‚ å¦Šå©¦æ”¯æ´çµ¦ä»˜ ã‚³ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼ 011-213-0383 é€£çµ¡å…ˆ">
              <h3>ä¸»ãªå•ã„åˆã‚ã›å…ˆ</h3>
              <div>æœ­å¹Œå¸‚å¦Šå©¦æ”¯æ´çµ¦ä»˜ã‚³ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼</div>
              <div style="margin-top:6px"><a class="link" href="tel:0112130383">ğŸ“± 011-213-0383</a></div>
            </section>
            <section class="info-card" data-search="çµ¦ä»˜é‡‘ åŠ©æˆé‡‘ å‡ºç”£è‚²å…ä¸€æ™‚é‡‘ å…ç«¥æ‰‹å½“ å­ã©ã‚‚åŒ»ç™‚è²»åŠ©æˆ æœ­å¹Œ">
              <h3>çµ¦ä»˜é‡‘ãƒ»åŠ©æˆé‡‘</h3>
              <ul style="margin:0;padding-left:1.2em;line-height:1.8">
                <li>å¦Šå©¦ã®ãŸã‚ã®æ”¯æ´çµ¦ä»˜ï¼šè¨ˆ10ä¸‡å††</li>
                <li>å‡ºç”£è‚²å…ä¸€æ™‚é‡‘ï¼š50ä¸‡å††</li>
                <li>å…ç«¥æ‰‹å½“ï¼šæœˆ15,000å††ã€œ</li>
                <li>å­ã©ã‚‚åŒ»ç™‚è²»åŠ©æˆï¼š18æ­³ã¾ã§</li>
              </ul>
            </section>
            <section class="info-card" data-search="æœ­å¹Œ å†¬ é›ªé“ ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼ é¸ã³æ–¹ é˜²å¯’ åŠ æ¹¿ ä¿æ¹¿">
              <h3>æœ­å¹Œãªã‚‰ã§ã¯ã®ãƒã‚¤ãƒ³ãƒˆ</h3>
              <ul style="margin:0;padding-left:1.2em;line-height:1.8">
                <li>é›ªé“ã¯â€œå¤§å¾„ã‚¿ã‚¤ãƒ¤ï¼ã‚¹ãƒãƒ¼ã‚½ãƒƒã‚¯ã‚¹â€å¯¾å¿œã®ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼ãŒå®‰å…¨</li>
                <li>å®¤å†…ã¯ä¹¾ç‡¥ã—ã‚„ã™ã„ã®ã§åŠ æ¹¿å™¨ã¨ä¿æ¹¿ã‚±ã‚¢ã‚’å¾¹åº•</li>
                <li>å¤–å‡ºæ™‚ã¯ãƒãƒƒã‚¯ã‚¦ã‚©ãƒ¼ãƒãƒ¼ãƒ»æ‰‹è¢‹ãªã©å†·ãˆå¯¾ç­–ã‚’</li>
                <li>å†¬å­£ã®ç§»å‹•ã¯æ™‚é–“ã«ä½™è£•ã‚’æŒã¤ï¼ˆè·¯é¢çŠ¶æ³ã«æ³¨æ„ï¼‰</li>
              </ul>
            </section>
          </div>
        </div>
      </article>
    </div>
  </section>

  <nav class="tabbar" role="tablist" aria-label="ãƒ¡ã‚¤ãƒ³">
    <button class="tabmain" data-target="panel-home" aria-selected="true" aria-controls="panel-home" tabindex="0">ğŸ <span style="font-size:11px">ãƒ›ãƒ¼ãƒ </span></button>
    <button class="tabmain" data-target="panel-list" aria-selected="false" aria-controls="panel-list" tabindex="-1">ğŸ“<span style="font-size:11px">ãƒªã‚¹ãƒˆ</span></button>
    <button class="tabmain" data-target="panel-info" aria-selected="false" aria-controls="panel-info" tabindex="-1">â„¹ï¸<span style="font-size:11px">æƒ…å ±</span></button>
    <button class="tabmain" id="btnDue" aria-selected="false" tabindex="-1">ğŸ“…<span style="font-size:11px">äºˆå®šæ—¥</span></button>
  </nav>

  <!-- Date Modal -->
  <div class="modal" id="dlgDue" role="dialog" aria-modal="true" aria-labelledby="dlgTitle" aria-describedby="dlgDesc">
    <div class="sheet" role="document">
      <div class="sheet-h"><div id="dlgTitle">ğŸ“… å‡ºç”£äºˆå®šæ—¥ã®è¨­å®š</div><button class="close-x" id="btnXDue" aria-label="é–‰ã˜ã‚‹">Ã—</button></div>
      <div class="sheet-b">
        <p id="dlgDesc" class="muted" style="margin-top:0">å‡ºç”£äºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚„ä»Šé€±ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
        <div class="field"><label for="inpDate">å‡ºç”£äºˆå®šæ—¥</label><input type="date" id="inpDate"/></div>
      </div>
      <div class="sheet-a">
        <button class="link" id="btnCancelDue">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="link" id="btnSaveDue">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Add Item Modal -->
  <div class="modal" id="dlgAdd" role="dialog" aria-modal="true" aria-labelledby="addTitle" aria-describedby="addDesc">
    <div class="sheet" role="document">
      <div class="sheet-h"><div id="addTitle">ï¼‹ é …ç›®ã‚’è¿½åŠ </div><button class="close-x" id="btnXAdd" aria-label="é–‰ã˜ã‚‹">Ã—</button></div>
      <div class="sheet-b">
        <p id="addDesc" class="muted" style="margin-top:0">ç”³è«‹æ‰‹ç¶šãï¼å‡ºç”£æº–å‚™ï¼å…¥é™¢æº–å‚™ã«ã€ä»»æ„ã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»é …ç›®ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>
        <div class="field">
          <label for="addCat">ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="addCat">
            <option value="applications">ç”³è«‹æ‰‹ç¶šã</option>
            <option value="preparation">å‡ºç”£æº–å‚™</option>
            <option value="hospital">å…¥é™¢æº–å‚™</option>
          </select>
        </div>
        <div class="field">
          <label for="addGroup">ã‚°ãƒ«ãƒ¼ãƒ—</label>
          <select id="addGroup"></select>
          <input id="addGroupNew" type="text" placeholder="æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—å" style="display:none"/>
        </div>
        <div class="field">
          <label for="addTitleInput">ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰</label>
          <input id="addTitleInput" type="text" placeholder="ä¾‹ï¼šæ¯å­æ‰‹å¸³ã®ã‚³ãƒ”ãƒ¼æå‡º"/>
        </div>
        <div class="field">
          <label for="addDescInput">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="addDescInput" rows="2" placeholder="è©³ç´°ã‚„å‚™è€ƒ"></textarea>
        </div>
        <div class="field">
          <label for="addBadge">ãƒãƒƒã‚¸ï¼ˆä»»æ„ï¼‰</label>
          <input id="addBadge" type="text" placeholder="ä¾‹ï¼šå¿…é ˆï¼æ¨å¥¨ ãªã©"/>
        </div>
      </div>
      <div class="sheet-a">
        <button class="link" id="btnCancelAdd">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="link" id="btnSaveAdd">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- App Script -->
  <script>
  (function(){
    'use strict';

    // ===== Supabaseæ¥ç¶š & ç·¨é›†ã‚­ãƒ¼ =====
    const SUPABASE_URL  = 'https://ixmdyjzgpiocfntpnmsqk.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4bWR5amdwaW9jZm50cG5tc3FrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDMxMDAsImV4cCI6MjA4NzU3OTEwMH0.Y0an3BMBSWUOxIoWx3kI96NuGTyBvgYt52VDzLiwR1Y';
    const EDIT_KEY = 'eme-0116';
    const EDIT_KEY_HINT_LEN = 6;
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    function setEditMode(on){ window.EDIT_ENABLED = !!on; document.body.dataset.edit = on?'on':'off'; }
    function needKey(){ if(!window.EDIT_ENABLED){ alert('ç·¨é›†ã‚­ãƒ¼ãŒå¿…è¦ã§ã™'); return true; } return false; }

    document.getElementById('btnEditOn')?.addEventListener('click', ()=>{
      const k = prompt('ç·¨é›†ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if(k===EDIT_KEY){ setEditMode(true); alert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ ON'); } else { alert('ç·¨é›†ã‚­ãƒ¼ãŒé•ã„ã¾ã™'); }
    });
    document.getElementById('btnEditOff')?.addEventListener('click', ()=>{ setEditMode(false); alert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ OFF'); });

    // ===== DOM util =====
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    // ===== æ—¢å®šãƒ‡ãƒ¼ã‚¿ =====
    const DATA_DEFAULT = {
      applications:[
        {g:'å¦Šå¨ ãŒã‚ã‹ã£ãŸã‚‰',items:[
          {id:'app-1',title:'å¦Šå¨ å±Šå‡ºï¼ˆæ¯å­å¥åº·æ‰‹å¸³ï¼‰',desc:'åŒºä¿å¥ã‚»ãƒ³ã‚¿ãƒ¼ã§äº¤ä»˜'},
          {id:'app-2',title:'å¦Šå©¦æ”¯æ´çµ¦ä»˜ï¼ˆ1å›ç›®ï¼‰',desc:'5ä¸‡å††æ”¯çµ¦'}
        ]},
        {g:'å‡ºç”£äºˆå®šæ—¥ã®8é€±å‰',items:[
          {id:'app-3',title:'å¦Šå©¦æ”¯æ´çµ¦ä»˜ï¼ˆ2å›ç›®ï¼‰',desc:'5ä¸‡å††æ”¯çµ¦'},
          {id:'app-4',title:'ç”£ä¼‘ç”³è«‹ï¼ˆä¼šç¤¾å“¡ï¼‰',desc:'å‹¤å‹™å…ˆã¸ç”³è«‹'}
        ]},
        {g:'âš ï¸ å‡ºç”£å¾Œã™ãï¼ˆ15æ—¥ä»¥å†…ï¼‰',items:[
          {id:'app-5',title:'å‡ºç”Ÿå±Š',desc:'14æ—¥ä»¥å†…å¿…é ˆ'},
          {id:'app-6',title:'å…ç«¥æ‰‹å½“',desc:'15æ—¥ä»¥å†…å¿…é ˆï¼é…ã‚Œã‚‹ã¨å—çµ¦é–‹å§‹ãŒé…ã‚Œã¾ã™'},
          {id:'app-7',title:'å­ã©ã‚‚åŒ»ç™‚è²»åŠ©æˆ',desc:'ã§ãã‚‹ã ã‘æ—©ãç”³è«‹'},
          {id:'app-8',title:'å¥åº·ä¿é™ºåŠ å…¥',desc:'å‹¤å‹™å…ˆã¾ãŸã¯åŒºå½¹æ‰€'},
          {id:'app-9',title:'å‡ºç”£è‚²å…ä¸€æ™‚é‡‘',desc:'50ä¸‡å††æ”¯çµ¦'}
        ]}
      ],
      preparation:[
        {g:'ğŸ‘© ãƒãƒç”¨å“',items:[
          {id:'prep-1',title:'ç”£è¤¥ã‚·ãƒ§ãƒ¼ãƒ„',badge:'å¿…é ˆ'},
          {id:'prep-2',title:'æˆä¹³ãƒ–ãƒ©',badge:'å¿…é ˆ'},
          {id:'prep-3',title:'æ¯ä¹³ãƒ‘ãƒƒãƒ‰',badge:'å¿…é ˆ'},
          {id:'prep-4',title:'æˆä¹³ã‚¯ãƒƒã‚·ãƒ§ãƒ³',badge:'æ¨å¥¨'}
        ]},
        {g:'ğŸ‘¶ èµ¤ã¡ã‚ƒã‚“è¡£é¡',items:[
          {id:'prep-10',title:'çŸ­è‚Œç€ï¼ˆ5ã€œ6æšï¼‰',badge:'å¿…é ˆ'},
          {id:'prep-11',title:'ã‚³ãƒ³ãƒ“è‚Œç€ï¼ˆ5ã€œ6æšï¼‰',badge:'å¿…é ˆ'},
          {id:'prep-12',title:'é˜²å¯’ç€ãƒ»ã‚¸ãƒ£ãƒ³ãƒ—ã‚¹ãƒ¼ãƒ„',badge:'å¿…é ˆ'}
        ]},
        {g:'ğŸ¼ æˆä¹³ãƒ»èª¿ä¹³ç”¨å“',items:[
          {id:'prep-20',title:'å“ºä¹³ç“¶',badge:'å¿…é ˆ'},
          {id:'prep-21',title:'ç²‰ãƒŸãƒ«ã‚¯',badge:'æ¨å¥¨'}
        ]}
      ],
      hospital:[
        {g:'ğŸ’ ãƒãƒï¼ˆåˆ†å¨©ã€œå…¥é™¢ï¼‰',items:[
          {id:'hosp-1',title:'æ¯å­å¥åº·æ‰‹å¸³ãƒ»ä¿é™ºè¨¼ãƒ»è¨ºå¯Ÿåˆ¸',badge:'å¿…é ˆ'},
          {id:'hosp-2',title:'å…¥é™¢æ›¸é¡ãƒ»å°é‘‘ãƒ»ç­†è¨˜ç”¨å…·',badge:'å¿…é ˆ'},
          {id:'hosp-3',title:'ç”£è¤¥ã‚·ãƒ§ãƒ¼ãƒ„ï¼ãƒŠãƒ—ã‚­ãƒ³',badge:'å¿…é ˆ'},
          {id:'hosp-4',title:'å‰é–‹ããƒ‘ã‚¸ãƒ£ãƒãƒ»ç¾½ç¹”ã‚Š',badge:'å¿…é ˆ'},
          {id:'hosp-5',title:'ã‚¹ãƒãƒ›å……é›»å™¨ï¼ˆé•·ã‚ã®ã‚±ãƒ¼ãƒ–ãƒ«ï¼‰',badge:'å¿…é ˆ'},
          {id:'hosp-6',title:'æ´—é¢ç”¨å…·ãƒ»ãƒªãƒƒãƒ—ãƒ»ä¿æ¹¿å‰¤',badge:'æ¨å¥¨'},
          {id:'hosp-7',title:'é£²ã¿ç‰©ç”¨ã‚¹ãƒˆãƒ­ãƒ¼ã‚­ãƒ£ãƒƒãƒ—',badge:'æ¨å¥¨'}
        ]},
        {g:'ğŸ§¸ èµ¤ã¡ã‚ƒã‚“',items:[
          {id:'hosp-10',title:'è‚Œç€ãƒ»ãŠãã‚‹ã¿',badge:'æ¨å¥¨'},
          {id:'hosp-11',title:'ãŠã—ã‚Šãµããƒ»ã‚¬ãƒ¼ã‚¼',badge:'æ¨å¥¨'},
          {id:'hosp-12',title:'é€€é™¢æ™‚ã®è¡£é¡ãƒ»é˜²å¯’å…·',badge:'å¿…é ˆ'}
        ]}
      ]
    };

    // ===== DB ãƒ˜ãƒ«ãƒ‘ =====
    async function dbLoadDue(){
      const { data, error } = await sb.from('profiles').select('due_date').eq('key','default').single();
      if(error && error.code!=='PGRST116') console.warn(error);
      return data?.due_date || null;
    }
    async function dbSaveDue(dateStr){
      if(needKey()) return;
      const { error } = await sb.from('profiles').upsert({
        key:'default', due_date:dateStr,
        client_ts:new Date().toISOString(),
        ua:navigator.userAgent,
        edit_key_hint: EDIT_KEY.slice(0,EDIT_KEY_HINT_LEN)
      });
      if(error) alert(error.message);
    }

    async function dbLoadChecks(){
      const { data, error } = await sb.from('checks').select('item_id, checked');
      if(error){ console.error(error); return {}; }
      const m={}; (data||[]).forEach(r=>m[r.item_id]=!!r.checked);
      return m;
    }
    async function dbSaveCheck(itemId, checked){
      if(needKey()) return;
      const { error } = await sb.from('checks').upsert({
        item_id:itemId, checked,
        client_ts:new Date().toISOString(),
        ua:navigator.userAgent,
        edit_key_hint: EDIT_KEY.slice(0,EDIT_KEY_HINT_LEN)
      });
      if(error) alert(error.message);
    }

    async function dbFetchCustom(cat){
      const { data, error } = await sb.from('custom_items')
        .select('id, category, grp, title, description, badge')
        .eq('category', cat).order('id', {ascending:true});
      if(error){ console.error(error); return []; }
      const map = new Map();
      (data||[]).forEach(row=>{
        if(!map.has(row.grp)) map.set(row.grp, []);
        map.get(row.grp).push({ id:`u-${row.id}`, title:row.title, desc:row.description||'', badge:row.badge||'' });
      });
      return Array.from(map.entries()).map(([g,items])=>({ g, items }));
    }
    async function dbAddCustom(cat, grp, title, desc, badge){
      if(needKey()) return;
      const { error } = await sb.from('custom_items').insert({
        category:cat, grp, title, description:desc, badge,
        client_ts:new Date().toISOString(), ua:navigator.userAgent,
        edit_key_hint: EDIT_KEY.slice(0,EDIT_KEY_HINT_LEN)
      });
      if(error) alert(error.message);
    }
    async function dbUpdateCustom(rowId, title, desc, badge){
      if(needKey()) return;
      const { error } = await sb.from('custom_items').update({
        title, description:desc, badge,
        updated_at:new Date().toISOString(),
        client_ts:new Date().toISOString(), ua:navigator.userAgent,
        edit_key_hint: EDIT_KEY.slice(0,EDIT_KEY_HINT_LEN)
      }).eq('id', rowId);
      if(error) alert(error.message);
    }
    async function dbDeleteCustom(rowId){
      if(needKey()) return;
      const { error } = await sb.from('custom_items').delete().eq('id', rowId);
      if(error) alert(error.message);
    }

    // ===== Default + Custom ã‚’ãƒãƒ¼ã‚¸ =====
    async function getDataMergedAsync(cat){
      const base = JSON.parse(JSON.stringify(DATA_DEFAULT[cat]||[]));
      const custom = await dbFetchCustom(cat);
      const map = new Map();
      base.forEach(grp=>map.set(grp.g,{g:grp.g, items:[...(grp.items||[])]}));
      custom.forEach(cg=>{
        if(map.has(cg.g)) map.get(cg.g).items.push(...(cg.items||[]));
        else map.set(cg.g,{g:cg.g, items:[...(cg.items||[])]});
      });
      return Array.from(map.values());
    }

    // ===== ãƒªã‚¹ãƒˆæç”» =====
    async function renderList(){
      const content = document.getElementById('tabContent'); if(!content) return;
      const key = window.CURRENT_TAB || 'applications';
      const kw  = (document.getElementById('kw')?.value||'').trim();
      const data = await getDataMergedAsync(key);
      const progress = await dbLoadChecks();

      content.innerHTML=''; const frag = document.createDocumentFragment(); let visible=0;
      data.forEach(grp=>{
        const matched = (grp.items||[]).filter(it=>{
          if(!kw) return true; const hay = `${it.title||''} ${(it.desc||'')} ${(it.badge||'')}`; return hay.includes(kw);
        });
        if(matched.length===0) return;

        const g = document.createElement('section'); g.className='group';
        const h = document.createElement('h3'); h.textContent=grp.g; g.appendChild(h);

        matched.forEach(it=>{
          const isUser = String(it.id||'').startsWith('u-');
          const item = document.createElement('div'); item.className='item'; item.dataset.id = it.id||'';
          const checked = !!progress[it.id];
          item.innerHTML =
            `<input type="checkbox" ${checked?'checked':''} aria-label="${it.title||''}">`+
            `<div class="check">${checked?'âœ“':''}</div>`+
            `<div style="flex:1 1 auto">`+
              `<div><strong>${it.title||''}</strong>${it.badge?` <span class="badge">${it.badge}</span>`:''}</div>`+
              `${it.desc?`<div class="meta">${it.desc}</div>`:''}`+
            `</div>`;

          const ops = document.createElement('div'); ops.className='ops';
          if(isUser){
            const bEdit=document.createElement('button'); bEdit.className='iconbtn'; bEdit.textContent='âœ'; bEdit.title='ç·¨é›†';
            bEdit.addEventListener('click', async (e)=>{
              e.stopPropagation(); if(needKey()) return;
              const title = prompt('ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç·¨é›†', it.title||''); if(title===null) return;
              const desc  = prompt('èª¬æ˜ï¼ˆä»»æ„ï¼‰', it.desc||'');   if(desc===null)  return;
              const badge = prompt('ãƒãƒƒã‚¸ï¼ˆä»»æ„ï¼‰', it.badge||''); if(badge===null) return;
              const rowId = Number(String(it.id).replace(/^u-/,'')||'0');
              await dbUpdateCustom(rowId, (title||'').trim(), (desc||'').trim(), (badge||'').trim());
              renderList();
            });
            const bDel=document.createElement('button'); bDel.className='iconbtn'; bDel.textContent='ğŸ—‘'; bDel.title='å‰Šé™¤';
            bDel.addEventListener('click', async (e)=>{
              e.stopPropagation(); if(needKey()) return;
              if(!confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
              const rowId = Number(String(it.id).replace(/^u-/,'')||'0');
              await dbDeleteCustom(rowId); renderList();
            });
            ops.appendChild(bEdit); ops.appendChild(bDel);
          }
          item.appendChild(ops);

          const cb  = item.querySelector('input');
          const dot = item.querySelector('.check');
          async function toggle(v){ if(needKey()) return; cb.checked=v; dot.textContent=v?'âœ“':''; await dbSaveCheck(it.id,v); updateProgress(); }
          cb.addEventListener('change', e=>toggle(e.target.checked));
          dot.addEventListener('click', e=>{ e.stopPropagation(); toggle(!cb.checked); });
          item.addEventListener('click', e=>{
            const t=e.target; if(t===cb) return; if(t.closest('.iconbtn')) return;
            if(['A','BUTTON','SELECT','TEXTAREA','INPUT','LABEL'].includes(t.tagName)) return;
            toggle(!cb.checked);
          });
          item.addEventListener('keydown', e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); toggle(!cb.checked); }});

          g.appendChild(item); visible++;
        });

        frag.appendChild(g);
      });

      if(visible===0){ const no=document.createElement('div'); no.className='nohit'; no.textContent='è©²å½“ã™ã‚‹é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰ãˆã¦ãŠè©¦ã—ãã ã•ã„ã€‚'; frag.appendChild(no); }
      content.appendChild(frag); updateProgress();
    }

    function updateProgress(){
      const total = document.querySelectorAll('#tabContent .item').length;
      const done  = document.querySelectorAll('#tabContent .item input[type="checkbox"]:checked').length;
      const pct   = total > 0 ? Math.round((done/total)*100) : 0;
      const el = document.getElementById('progress'); if(el) el.textContent = `é€²æ— ${pct}%`;
    }

    // ===== è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« =====
    const dlgAdd = document.getElementById('dlgAdd');
    const selCat = document.getElementById('addCat');
    const selGroup = document.getElementById('addGroup');
    const inputGroupNew = document.getElementById('addGroupNew');

    function rebuildGroupOptions(){
      const key = selCat.value;
      getDataMergedAsync(key).then(merged=>{
        selGroup.innerHTML='';
        const optNew=document.createElement('option'); optNew.value='__new__'; optNew.textContent='ï¼‹ æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—â€¦';
        selGroup.appendChild(optNew);
        merged.forEach(grp=>{ const o=document.createElement('option'); o.value=grp.g; o.textContent=grp.g; selGroup.appendChild(o); });
        inputGroupNew.style.display = (selGroup.value==='__new__')?'block':'none';
      });
    }
    function openAdd(){
      if(needKey()) return;
      selCat.value = window.CURRENT_TAB || 'applications';
      rebuildGroupOptions();
      document.getElementById('addTitleInput').value='';
      document.getElementById('addDescInput').value='';
      document.getElementById('addBadge').value='';
      dlgAdd.style.display='flex';
      setTimeout(()=>document.getElementById('addTitleInput').focus(),20);
    }
    function closeAdd(){ dlgAdd.style.display='none'; }

    selCat.addEventListener('change', rebuildGroupOptions);
    selGroup.addEventListener('change', ()=>{
      inputGroupNew.style.display = (selGroup.value==='__new__')?'block':'none';
      if(selGroup.value==='__new__') inputGroupNew.focus();
    });
    document.getElementById('btnAdd')?.addEventListener('click', openAdd);
    document.getElementById('btnAdd2')?.addEventListener('click', openAdd);
    document.getElementById('btnXAdd')?.addEventListener('click', closeAdd);
    document.getElementById('btnCancelAdd')?.addEventListener('click', closeAdd);
    document.getElementById('btnSaveAdd')?.addEventListener('click', async ()=>{
      const cat = selCat.value;
      let grp = selGroup.value;
      if(grp==='__new__') grp = (inputGroupNew.value||'').trim();
      const title = (document.getElementById('addTitleInput').value||'').trim();
      const desc  = (document.getElementById('addDescInput').value||'').trim();
      const badge = (document.getElementById('addBadge').value||'').trim();
      if(!title){ alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if(!grp){ alert('ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸ã¶ã‹å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      await dbAddCustom(cat, grp, title, desc, badge);
      closeAdd(); renderList();
    });

    // ===== ä¸‹éƒ¨ã‚¿ãƒ– =====
    (function(){
      const tabs = $$('.tabbar .tabmain');
      function selectTab(btn){
        const target = btn.dataset.target;
        tabs.forEach(t=>{ const on=(t===btn); t.setAttribute('aria-selected',on?'true':'false'); t.tabIndex = on?0:-1; });
        ['panel-home','panel-list','panel-info'].forEach(id=>{
          const show = (id===target);
          const el = document.getElementById(id); if(el) el.setAttribute('aria-hidden',show?'false':'true');
        });
      }
      tabs.forEach(btn=>btn.addEventListener('click',()=>{
        if(btn.id==='btnDue'){ openDue(); return; }
        selectTab(btn);
      }));
    })();

    // ===== äºˆå®šæ—¥ãƒ¢ãƒ¼ãƒ€ãƒ« =====
    const dlgDue = document.getElementById('dlgDue');
    function openDue(){
      const el = document.getElementById('inpDate');
      const today = new Date();
      const min = new Date(today.getTime() - 315*24*3600*1000); // å¦Šå¨ 0é€±ç›¸å½“ï¼ˆæœ€å¤§45é€±å‰ï¼‰
      const max = new Date(today.getTime() + 315*24*3600*1000); // å‡ºç”£äºˆå®šæ—¥æœ€å¤§45é€±å…ˆ
      const fmt = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      el.min = fmt(min); el.max = fmt(max);
      dbLoadDue().then(d=>{ el.value = d || fmt(today); });
      dlgDue.style.display='flex';
      setTimeout(()=>el.focus(),20);
    }
    function closeDue(){ dlgDue.style.display='none'; }
    document.getElementById('btnDue2')?.addEventListener('click', openDue);
    document.getElementById('btnXDue')?.addEventListener('click', closeDue);
    document.getElementById('btnCancelDue')?.addEventListener('click', closeDue);
    document.getElementById('btnSaveDue')?.addEventListener('click', async ()=>{
      const v = document.getElementById('inpDate').value; if(!v) return;
      await dbSaveDue(v); closeDue(); updateAll(v);
    });

    // ===== ã‚¢ãƒ‰ãƒã‚¤ã‚¹ & æˆé•· & ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ =====
    const ADVICE={
      0:['ç„¡ç†ã›ãšä¼‘æ¯ã‚’ã€‚ä½“èª¿ã«åˆã‚ã›ã¦éã”ã—ã¾ã—ã‚‡ã†','è‘‰é…¸ãªã©å¿…è¦ãªæ „é¤Šã‚’æ„è­˜ã—ã¦æ‘‚ã‚Šã¾ã—ã‚‡ã†'],
      8:['ã¤ã‚ã‚Šã®ãƒ”ãƒ¼ã‚¯æ™‚æœŸã€‚åŒ‚ã„ãƒ»æ™‚é–“å¸¯ã®å·¥å¤«ã§è»½æ¸›ã‚’','æ¯å­æ‰‹å¸³ã‚’å—ã‘å–ã‚Šã¾ã—ã‚‡ã†'],
      16:['å®‰å®šæœŸã«ã€‚é©åº¦ãªé‹å‹•ã‚’å§‹ã‚ã¾ã—ã‚‡ã†','æ­¯ç§‘æ¤œè¨ºã‚’å—ã‘ã¾ã—ã‚‡ã†','æˆŒã®æ—¥ã®å®‰ç”£ç¥ˆé¡˜ã‚’æ¤œè¨'],
      24:['ä½“é‡ç®¡ç†ã«æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†','å¦Šå¨ ç·šäºˆé˜²ã‚±ã‚¢ã‚’é–‹å§‹','ãƒ™ãƒ“ãƒ¼ç”¨å“ã®æº–å‚™ã‚’é–‹å§‹'],
      32:['å‡ºç”£æº–å‚™å“ãƒªã‚¹ãƒˆã‚’ä½œæˆ','é‡Œå¸°ã‚Šå‡ºç”£ã®å ´åˆã¯ç§»å‹•æ™‚æœŸã®æ¤œè¨','ç”£å¾Œã®æ‰‹ç¶šãã‚’ç¢ºèª'],
      36:['å…¥é™¢ãƒãƒƒã‚°ã®æº–å‚™å®Œäº†ã‚’','é™£ç—›ã‚¿ã‚¯ã‚·ãƒ¼ç™»éŒ²','ãƒãƒ¼ã‚¹ãƒ—ãƒ©ãƒ³ã‚’è©±ã—åˆã„ã¾ã—ã‚‡ã†'],
      40:['å‡ºç”£æº–å‚™ã¯ä¸‡å…¨ã«ã€‚ç„¦ã‚‰ãšä½“ã‚’ä¼‘ã‚ã¾ã—ã‚‡ã†']
    };
    const GROWTH={
      8:{size:'1.6cm',weight:'1g'},12:{size:'6cm',weight:'14g'},16:{size:'12cm',weight:'100g'},
      20:{size:'25cm',weight:'300g'},24:{size:'30cm',weight:'600g'},28:{size:'37cm',weight:'1000g'},
      32:{size:'42cm',weight:'1700g'},36:{size:'47cm',weight:'2500g'},40:{size:'50cm',weight:'3200g'}
    };
    const TL=[
      {type:'week', w:28, title:'é‡Œå¸°ã‚Šå‡ºç”£ã®ç§»å‹•æ™‚æœŸã‚’ç¢ºèª', desc:'é£›è¡Œæ©Ÿãƒ»é•·è·é›¢ç§»å‹•ã®å¯å¦ã‚’ä¸»æ²»åŒ»ã¨ç›¸è«‡'},
      {type:'week', w:30, title:'é‡Œå¸°ã‚Šå…ˆã«é€£çµ¡ãƒ»ç´¹ä»‹çŠ¶ä¾é ¼', desc:'åˆ†å¨©äºˆç´„ã¨è¨ºç™‚æƒ…å ±æä¾›æ›¸ã®æº–å‚™'},
      {type:'week', w:32, title:'å…¥é™¢æº–å‚™ãƒªã‚¹ãƒˆã®ç€æ‰‹', desc:'æ¶ˆè€—å“ã‚„å­£ç¯€ç‰©ã®ä¸è¶³ã‚’ãƒã‚§ãƒƒã‚¯'},
      {type:'week', w:34, title:'ãƒ™ãƒ“ãƒ¼ç”¨å“ã®æœ€çµ‚ç¢ºèª', desc:'ãƒãƒ£ã‚¤ãƒ«ãƒ‰ã‚·ãƒ¼ãƒˆãƒ»è‚Œç€ãƒ»é˜²å¯’å…·'},
      {type:'week', w:35, title:'é™£ç—›ã‚¿ã‚¯ã‚·ãƒ¼ç™»éŒ²', desc:'é™é›ªæœŸã¯æ—©ã‚ã®ç™»éŒ²ãŒãŠã™ã™ã‚'},
      {type:'week', w:36, title:'å…¥é™¢ãƒãƒƒã‚°å®Œæˆ', desc:'æ¯å­æ‰‹å¸³ãƒ»æ›¸é¡ãƒ»å……é›»å™¨ãªã©æœ€çµ‚ç¢ºèª'},
      {type:'week', w:37, title:'ã„ã¤ã§ã‚‚å‡ºç”£OKã®ä½“åˆ¶ã¸', desc:'å¤œé–“é€£çµ¡å…ˆãƒ»äº¤é€šæ‰‹æ®µã‚’å†ç¢ºèª'},
      {type:'week', w:38, title:'å†·å‡ä½œã‚Šç½®ãï¼å®…é…æ‰‹é…', desc:'ç”£å¾Œã®é£Ÿäº‹ã®æ®µå–ã‚Š'},
      {type:'after', d:0,  title:'å‡ºç”Ÿå±Šã®æº–å‚™', desc:'å¿…è¦æ›¸é¡ãƒ»è¨˜å…¥äº‹é …ã‚’ç¢ºèªï¼ˆæå‡ºã¯14æ—¥ä»¥å†…ï¼‰'},
      {type:'after', d:3,  title:'å¥åº·ä¿é™ºã®åŠ å…¥æ‰‹ç¶šã', desc:'å‹¤å‹™å…ˆã¾ãŸã¯åŒºå½¹æ‰€'},
      {type:'after', d:7,  title:'å­ã©ã‚‚åŒ»ç™‚è²»åŠ©æˆã®ç”³è«‹', desc:'æ—©ã‚ã«æ‰‹ç¶šã'},
      {type:'after', d:14, title:'å…ç«¥æ‰‹å½“ã®ç”³è«‹ï¼ˆ15æ—¥ä»¥å†…ï¼‰', desc:'é…ã‚Œã‚‹ã¨å—çµ¦é–‹å§‹ãŒé…ã‚Œã¾ã™'}
    ];

    function updateAll(dueStr){
      if(!dueStr) return;
      const due=new Date(dueStr); if(Number.isNaN(+due)) return;
      const today=new Date(); today.setHours(0,0,0,0); due.setHours(0,0,0,0);
      const diff=due-today; const daysLeft=Math.ceil(diff/(1000*60*60*24));
      const TOTAL=280; let elapsed=TOTAL-daysLeft; if(elapsed<0) elapsed=0; if(elapsed>TOTAL) elapsed=TOTAL;
      const weeks=Math.floor(elapsed/7), days=elapsed%7;

      const dueDateEl=document.getElementById('dueDate'); if(dueDateEl) dueDateEl.textContent=(due.getMonth()+1)+'/'+due.getDate();
      const daysLeftEl=document.getElementById('daysLeft'); const dueLabelEl=document.getElementById('dueLabel');
      if(daysLeft>0){ if(daysLeftEl) daysLeftEl.textContent=`${daysLeft}æ—¥`; if(dueLabelEl) dueLabelEl.textContent='å‡ºç”£äºˆå®šæ—¥ã¾ã§'; }
      else if(daysLeft===0){ if(daysLeftEl) daysLeftEl.textContent='ãã‚‡ã†ï¼'; if(dueLabelEl) dueLabelEl.textContent='å‡ºç”£äºˆå®šæ—¥'; }
      else { if(daysLeftEl) daysLeftEl.textContent='èª•ç”Ÿï¼'; if(dueLabelEl) dueLabelEl.textContent=`å‡ºç”£ã‹ã‚‰ ${Math.abs(daysLeft)}æ—¥`; }

      const cwEl=document.getElementById('currentWeek'); if(cwEl) cwEl.textContent=`${weeks}é€±${days}æ—¥`;
      const wkEl=document.getElementById('wk'); if(wkEl) wkEl.textContent=`${weeks}é€±`;

      let cur=8; Object.keys(GROWTH).map(Number).sort((a,b)=>a-b).forEach(w=>{ if(weeks>=w) cur=w; }); if(weeks>=40) cur=40;
      const sizeEl=document.getElementById('babySize'); if(sizeEl) sizeEl.textContent=GROWTH[cur].size;
      const weightEl=document.getElementById('babyWeight'); if(weightEl) weightEl.textContent=GROWTH[cur].weight;

      let adv=ADVICE[0]; Object.keys(ADVICE).map(Number).sort((a,b)=>a-b).forEach(w=>{ if(weeks>=w) adv=ADVICE[w]; });
      const advEl=document.getElementById('adviceList'); if(advEl) advEl.innerHTML=adv.map(x=>`<li>${x}</li>`).join('');
      renderTimeline(due,weeks,days,daysLeft);
    }

    function renderTimeline(due,weeks,days,daysLeft){
      const box=document.getElementById('timelineList'); if(!box) return;
      box.innerHTML=''; const today=new Date(); today.setHours(0,0,0,0);
      const frag=document.createDocumentFragment();
      for(const it of TL){
        let whenStr='';
        if(it.type==='week'){
          const targetElapsed=it.w*7; const delta=(targetElapsed-(weeks*7+days));
          const date=new Date(today.getTime()+delta*24*3600*1000);
          whenStr=`å¦Šå¨ ${it.w}é€±ã”ã‚ï¼ˆ${date.getMonth()+1}/${date.getDate()}é ƒï¼‰`;
        } else {
          const date=new Date(due.getTime()+it.d*24*3600*1000);
          whenStr=`å‡ºç”£å¾Œ${it.d}æ—¥ã”ã‚ï¼ˆ${date.getMonth()+1}/${date.getDate()}é ƒï¼‰`;
        }
        const el=document.createElement('div'); el.className='tl card'; el.style.padding='10px 12px';
        el.innerHTML = `<div class="when" style="font-weight:900;color:#c74363">${whenStr}</div>`+
                       `<div><strong>${it.title}</strong><div class="meta">${it.desc||''}</div></div>`;
        frag.appendChild(el);
      }
      box.appendChild(frag);
    }

    // ===== ã‚µãƒ–ã‚¿ãƒ– =====
    (function(){
      const tabs=$$('.tabs .tab'); if(!tabs.length) return;
      async function setActive(btn){
        tabs.forEach(t => t.setAttribute('aria-selected', t===btn ? 'true' : 'false'));
        window.CURRENT_TAB = btn.dataset.tab; await renderList();
      }
      tabs.forEach(btn => btn.addEventListener('click', () => setActive(btn)));
      setActive(tabs[0]);
    })();

    // ===== ãƒªã‚»ãƒƒãƒˆ =====
    document.getElementById('btnResetChecks')?.addEventListener('click', async ()=>{
      if(needKey()) return; if(!confirm('ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®ã¿ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      const { error } = await sb.from('checks').delete().neq('item_id','');
      if(error){ alert('å¤±æ•—ã—ã¾ã—ãŸ'); console.error(error); }
      await renderList();
    });
    document.getElementById('btnResetCustom')?.addEventListener('click', async ()=>{
      if(needKey()) return; if(!confirm('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ã®é …ç›®ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      const { error } = await sb.from('custom_items').delete().neq('id',0);
      if(error){ alert('å¤±æ•—ã—ã¾ã—ãŸ'); console.error(error); }
      await renderList();
    });

    // ===== æ¤œç´¢ =====
    document.getElementById('kw')?.addEventListener('input', ()=>{ renderList(); filterInfoCards(); });
    function filterInfoCards(){
      const kw=(document.getElementById('kw')?.value||'').trim();
      const cards=$$('#infoGrid .info-card'); let any=false;
      cards.forEach(c=>{
        const hay=((c.dataset.search||c.textContent||'').replace(/\s+/g,' ').trim());
        const hit=(!kw || hay.includes(kw));
        c.style.display=hit?'':'none'; if(hit) any=true;
      });
      if(!document.getElementById('infoNoHit')){
        const d=document.createElement('div'); d.id='infoNoHit'; d.className='nohit'; d.style.display='none';
        d.textContent='è©²å½“ã™ã‚‹æƒ…å ±ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
        const bd=document.querySelector('#panel-info .bd'); if(bd) bd.appendChild(d);
      }
      document.getElementById('infoNoHit').style.display=any?'none':'';
    }

    // ===== åˆæœŸåŒ– =====
    (async function init(){
      setEditMode(false); // èµ·å‹•æ™‚ã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰
      await renderList(); filterInfoCards();
      const d = await dbLoadDue(); if(d) updateAll(d);
    })();

  })();
  </script>
</body>
</html>
